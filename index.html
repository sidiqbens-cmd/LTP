<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Libyan Theses Portal | LTP</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --red: #e74c3c; --green: #27ae60; --dark: #2d3436; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; margin: 0; padding: 5px; font-size: 14px; }
        header { background: white; border-bottom: 4px solid #000; padding: 10px; text-align: center; margin-bottom: 5px; }
        .h-red { color: var(--red); font-size: 16px; margin: 0; }
        .h-black { color: #000; font-size: 48px; font-weight: 900; margin: -5px 0; }
        .h-green { color: var(--green); font-size: 16px; margin: 0; }

        .section-box { background: #fff; padding: 10px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 8px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        input, select { height: 32px; border: 1px solid #ccc; border-radius: 3px; padding: 0 8px; font-size: 13px; width: 100%; box-sizing: border-box; }
        
        .tab-btn { padding: 8px 15px; cursor: pointer; border: none; background: #ddd; font-weight: bold; }
        .tab-btn.active { background: var(--dark); color: white; }

        .btn-save { background: var(--green); color: white; height: 35px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; padding: 0 25px; }
        
        .table-wrap { height: 40vh; overflow-y: auto; background: white; border: 1px solid #ddd; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f8f9fa; position: sticky; top: 0; padding: 8px; border: 1px solid #ddd; }
        td { padding: 6px; border: 1px solid #eee; text-align: center; }
    </style>
</head>
<body>

<header>
    <p class="h-red">بوابة الرسائل الجامعية</p>
    <p class="h-black">LTP</p>
    <p class="h-green">Libyan Theses Portal</p>
</header>

<div style="margin-bottom: 10px;">
    <button class="tab-btn active" onclick="showTab('tab-data')">إدخال الرسائل</button>
    <button class="tab-btn" onclick="showTab('tab-library')">انضمام المكتبات</button>
</div>

<div id="tab-data" class="tab-content">
    <div class="section-box grid-4">
        <input type="text" id="f-title" placeholder="عنوان الرسالة" class="nav" style="grid-column: span 2;">
        <input type="text" id="f-author" placeholder="اسم الباحث" class="nav">
        <input type="text" id="f-supervisor" placeholder="المشرف" class="nav">
        <select id="f-uni" class="nav"><option value="">الجامعة</option><option>طرابلس</option><option>بنغازي</option></select>
        <select id="f-college" class="nav"><option value="">الكلية</option><option>الآداب</option><option>الهندسة</option></select>
        <select id="f-dept" class="nav"><option value="">القسم</option><option>المكتبات</option><option>الحاسوب</option></select>
        <input type="number" id="f-year" value="2026" class="nav">
        <input type="text" id="f-loc" placeholder="مكان الرسالة (المكتبة المودعة)" class="nav" style="grid-column: span 2;">
        <input type="text" id="f-id" placeholder="رقم الرسالة" class="nav">
        <button class="btn-save" id="btnSave">حفظ الرسالة</button>
    </div>

    <div class="section-box" style="background:#dfe6e9; border-right: 5px solid var(--green);">
        <div class="grid-4" style="grid-template-columns: 2fr 1fr 1fr 1fr 1fr;">
            <input type="text" id="s-title" placeholder="بحث بالعنوان...">
            <select id="s-uni"><option value="">كل الجامعات</option><option>طرابلس</option></select>
            <select id="s-dept"><option value="">كل الأقسام</option><option>المكتبات</option></select>
            <input type="number" id="s-year" placeholder="سنة">
            <button style="background:var(--dark); color:white; border:none; border-radius:3px;" onclick="exportExcel()">تصدير للبحث</button>
        </div>
    </div>
</div>

<div id="tab-library" class="tab-content" style="display:none;">
    <div class="section-box grid-4">
        <input type="text" id="lib-name" placeholder="اسم المكتبة">
        <input type="text" id="lib-address" placeholder="العنوان بالتفصيل">
        <select id="lib-type"><option value="">نوع التبعية</option><option>جامعية</option><option>عامة</option><option>مركز بحوث</option></select>
        <input type="number" id="lib-founded" placeholder="سنة التأسيس">
        <input type="email" id="lib-email" placeholder="البريد الإلكتروني">
        <input type="text" id="lib-phone" placeholder="بيانات الاتصال (هاتف)">
        <input type="password" id="lib-pass" placeholder="كلمة المرور">
        <button class="btn-save" onclick="registerLibrary()">تسجيل المكتبة</button>
    </div>
</div>

<div class="table-wrap">
    <table id="mainTable">
        <thead>
            <tr>
                <th>العنوان / الباحث</th>
                <th>الجامعة / الكلية</th>
                <th>القسم</th>
                <th>مكان التواجد</th>
                <th>الرقم</th>
                <th>السنة</th>
                <th>إجراءات</th>
            </tr>
        </thead>
        <tbody id="rows"></tbody>
    </table>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBU-Y2l1rrpAPOpDhEXI7WjwACx0LgZLX0",
      authDomain: "ltp-libya.firebaseapp.com",
      projectId: "ltp-libya",
      appId: "1:761649252036:web:96e615cae0a5584f3bab91"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // تبديل التبويبات
    function showTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).style.display = 'block';
        event.currentTarget.classList.add('active');
    }

    // تسجيل مكتبة
    async function registerLibrary() {
        const libData = {
            name: document.getElementById('lib-name').value,
            address: document.getElementById('lib-address').value,
            type: document.getElementById('lib-type').value,
            founded: document.getElementById('lib-founded').value,
            email: document.getElementById('lib-email').value,
            phone: document.getElementById('lib-phone').value,
            pass: document.getElementById('lib-pass').value, // ملاحظة: في النسخة النهائية يستخدم Auth
            regDate: firebase.firestore.FieldValue.serverTimestamp()
        };
        if(!libData.name || !libData.email) return alert("أكمل بيانات المكتبة");
        await db.collection("libraries").add(libData);
        alert("تم تسجيل طلب انضمام المكتبة بنجاح!");
    }

    // حفظ الرسائل والتصفية (نفس الكود السابق المصلح)
    document.getElementById('btnSave').onclick = async function() {
        const data = {
            title: document.getElementById('f-title').value,
            author: document.getElementById('f-author').value,
            uni: document.getElementById('f-uni').value,
            college: document.getElementById('f-college').value,
            dept: document.getElementById('f-dept').value,
            loc: document.getElementById('f-loc').value,
            year: document.getElementById('f-year').value,
            id_t: document.getElementById('f-id').value,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection("theses").add(data);
        alert("تم الحفظ!");
    };

    function loadData() {
        db.collection("theses").orderBy("timestamp", "desc").onSnapshot(snap => {
            const body = document.getElementById('rows');
            const sTitle = document.getElementById('s-title').value.toLowerCase();
            const sUni = document.getElementById('s-uni').value;
            const sDept = document.getElementById('s-dept').value;
            const sYear = document.getElementById('s-year').value;

            body.innerHTML = '';
            snap.forEach(doc => {
                const d = doc.data();
                if ((!sTitle || d.title.toLowerCase().includes(sTitle)) &&
                    (!sUni || d.uni === sUni) &&
                    (!sDept || d.dept === sDept) &&
                    (!sYear || d.year == sYear)) {
                    
                    body.insertAdjacentHTML('beforeend', `<tr>
                        <td style="text-align:right"><b>${d.title}</b><br><small>${d.author}</small></td>
                        <td>${d.uni}<br><small>${d.college}</small></td>
                        <td>${d.dept}</td>
                        <td>${d.loc}</td>
                        <td style="color:blue; font-weight:bold">${d.id_t}</td>
                        <td>${d.year}</td>
                        <td><button onclick="delDoc('${doc.id}')" style="background:red; color:white; border:none; padding:2px 5px; cursor:pointer">حذف</button></td>
                    </tr>`);
                }
            });
        });
    }

    ['s-title', 's-uni', 's-dept', 's-year'].forEach(id => {
        document.getElementById(id).addEventListener('input', loadData);
    });

    async function delDoc(id) { if(confirm("حذف؟")) await db.collection("theses").doc(id).delete(); }
    window.onload = loadData;
</script>
</body>
</html>
