<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الفهرس الليبي الموحد | LTP</title>
    <style>
        :root { --primary: #1a2a3a; --accent: #3498db; --success: #27ae60; --light: #f8f9fa; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #e9ecef; margin: 0; padding: 5px; font-size: 12px; color: #333; overflow: hidden; }
        .dashboard { max-width: 1400px; margin: auto; background: white; border-radius: 4px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); height: 98vh; display: flex; flex-direction: column; }
        
        header { background: var(--primary); color: white; padding: 5px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent); }
        header h1 { margin: 0; font-size: 1rem; }
        .lang-en { font-family: Arial; font-size: 0.8rem; opacity: 0.8; margin-right: 10px; border-right: 1px solid #555; padding-right: 10px; }

        .entry-section { padding: 8px; background: var(--light); border-bottom: 1px solid #ddd; }
        .grid-container { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; }
        .triple { grid-column: span 3; }
        .double { grid-column: span 2; }
        
        input, select { padding: 3px 8px; border: 1px solid #bbb; border-radius: 3px; width: 100%; box-sizing: border-box; font-size: 11px; height: 26px; }
        label { display: block; margin-bottom: 1px; font-weight: 600; font-size: 10px; color: #555; }

        .btn-group { display: flex; gap: 5px; justify-content: flex-end; align-items: flex-end; }
        button { padding: 4px 12px; border: none; border-radius: 3px; cursor: pointer; font-weight: bold; font-size: 11px; height: 26px; }
        .btn-save { background: var(--success); color: white; }
        .btn-export { background: #6c757d; color: white; }

        .search-section { padding: 8px; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .search-bar { margin-bottom: 5px; display: flex; gap: 5px; background: #eee; padding: 4px; border-radius: 3px; }
        
        .table-wrapper { flex-grow: 1; overflow-y: auto; border: 1px solid #eee; background: white; }
        .dense-table { width: 100%; border-collapse: collapse; font-size: 11px; table-layout: fixed; }
        .dense-table th { background: #f1f1f1; padding: 5px; text-align: right; border: 1px solid #ddd; position: sticky; top: 0; z-index: 10; }
        .dense-table td { padding: 3px 6px; border: 1px solid #eee; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .dense-table tr:hover { background: #f1f7fd; }
        
        .status-badge { padding: 1px 4px; border-radius: 3px; font-size: 9px; color: white; }
        .available { background: var(--success); }
    </style>
</head>
<body>

<div class="dashboard">
    <header>
        <h1>بوابة الرسائل الجامعية الليبية <span class="lang-en">Libyan Theses Portal</span></h1>
        <div style="font-size: 9px;">الفهرس الليبي الموحد v1.0</div>
    </header>

    <div class="entry-section">
        <div class="grid-container">
            <div class="triple"><label>عنوان الرسالة</label><input type="text" id="in-title" placeholder="العنوان الكامل..."></div>
            <div class="double"><label>الباحث</label><input type="text" id="in-author"></div>
            <div><label>السنة</label><input type="number" id="in-year" value="2026"></div>
            
            <div class="double"><label>المشرف</label><input type="text" id="in-supervisor"></div>
            <div><label>الجامعة</label>
                <select id="in-uni">
                    <option>جامعة طرابلس</option>
                    <option>جامعة بنغازي</option>
                    <option>جامعة سبها</option>
                    <option>جامعة الزاوية</option>
                    <option>جامعة مصراتة</option>
                </select>
            </div>
            <div><label>الدرجة</label><select id="in-degree"><option>ماجستير</option><option>دكتوراه</option></select></div>
            <div><label>رقم الرسالة</label><input type="text" id="in-id"></div>
            <div class="double btn-group">
                <button class="btn-export" onclick="window.location.reload()">تحديث الفهرس</button>
                <button class="btn-save" id="mainSaveBtn">حفظ في الفهرس</button>
            </div>
        </div>
    </div>

    <div class="search-section">
        <div class="search-bar">
            <input type="text" id="mainSearch" style="flex: 3" placeholder="بحث سريع بالعنوان أو الباحث...">
            <input type="text" style="flex: 1" placeholder="تصفية بالجامعة...">
        </div>
        
        <div class="table-wrapper">
            <table class="dense-table">
                <thead>
                    <tr>
                        <th width="40px">#</th>
                        <th>العنوان</th>
                        <th width="150px">الباحث / المشرف</th>
                        <th width="120px">الجامعة</th>
                        <th width="60px">السنة</th>
                        <th width="80px">الحالة</th>
                    </tr>
                </thead>
                <tbody id="results-body">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // 1. وظيفة حفظ البيانات (تنزيل ملف JSON)
    document.getElementById('mainSaveBtn').onclick = function() {
        const data = {
            title: document.getElementById('in-title').value,
            author: document.getElementById('in-author').value,
            supervisor: document.getElementById('in-supervisor').value,
            university: document.getElementById('in-uni').value,
            year: document.getElementById('in-year').value,
            id: document.getElementById('in-id').value,
            degree: document.getElementById('in-degree').value,
            status: "متوفرة"
        };

        if(!data.title || !data.author) {
            alert("الرجاء إدخال العنوان واسم الباحث");
            return;
        }

        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `thesis-${data.id || Date.now()}.json`;
        a.click();
        alert("تم تحميل الملف بنجاح! قم برفعه الآن لمجلد data في GitHub.");
    };

    // 2. جلب البيانات وعرضها في الجدول
    async function loadData() {
        const tbody = document.getElementById('results-body');
        try {
            const response = await fetch('data/master_index.json');
            if (!response.ok) throw new Error();
            const items = await response.json();
            
            tbody.innerHTML = ''; 
            items.forEach((item, index) => {
                if(!item.title) return;
                const row = `
                    <tr>
                        <td style="text-align:center">${index + 1}</td>
                        <td title="${item.title}" style="font-weight:bold">${item.title}</td>
                        <td title="${item.author}">${item.author} <br><small>${item.supervisor || ''}</small></td>
                        <td>${item.university}</td>
                        <td style="text-align:center">${item.year}</td>
                        <td style="text-align:center"><span class="status-badge available">متوفرة</span></td>
                    </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        } catch (e) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">في انتظار رفع البيانات...</td></tr>';
        }
    }

    // 3. البحث الحي
    document.getElementById('mainSearch').onkeyup = function() {
        let val = this.value.toLowerCase();
        document.querySelectorAll('#results-body tr').forEach(tr => {
            tr.style.display = tr.innerText.toLowerCase().includes(val) ? '' : 'none';
        });
    };

    window.onload = loadData;
</script>
</body>
</html>
