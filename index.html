<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBU-Y2l1rrpAPOpDhEXI7WjwACx0LgZLX0",
      authDomain: "ltp-libya.firebaseapp.com",
      projectId: "ltp-libya",
      storageBucket: "ltp-libya.firebasestorage.app",
      messagingSenderId: "761649252036",
      appId: "1:761649252036:web:96e615cae0a5584f3bab91"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // حفظ لحظي - بدون تنزيل ملفات
    document.getElementById('btnSave').onclick = async function() {
        const data = {
            title: document.getElementById('f-title').value,
            author: document.getElementById('f-author').value,
            supervisor: document.getElementById('f-supervisor').value,
            university: document.getElementById('f-uni').value,
            dept: document.getElementById('f-dept').value,
            year: document.getElementById('f-year').value,
            status: document.getElementById('f-status').value,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        if(!data.title || !data.author) return alert("أدخل البيانات الأساسية");

        try {
            await db.collection("theses").add(data);
            // إفراغ الخانات فوراً لتسهيل العمل المتتابع
            document.getElementById('f-title').value = '';
            document.getElementById('f-author').value = '';
            document.getElementById('f-supervisor').value = '';
            console.log("Data saved to Cloud");
        } catch(e) { alert("خطأ في الاتصال بالسحابة"); }
    };

    // استيراد إكسل دفعة واحدة للسحابة
    document.getElementById('btnExcel').onclick = function() {
        const input = document.createElement('input');
        input.type = 'file'; input.accept = '.xlsx';
        input.onchange = e => {
            const reader = new FileReader();
            reader.onload = async ev => {
                const rows = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(ev.target.result), {type:'array'}).Sheets[XLSX.read(new Uint8Array(ev.target.result), {type:'array'}).SheetNames[0]]);
                const batch = db.batch();
                rows.forEach(r => {
                    const ref = db.collection("theses").doc();
                    batch.set(ref, { 
                        title: r['العنوان'], author: r['الباحث'], university: r['الجامعة'], 
                        year: r['السنة'], status: r['الحالة']||'متوفرة',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                    });
                });
                await batch.commit();
                alert("تم رفع " + rows.length + " رسالة للسحابة بنجاح!");
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        };
        input.click();
    };

    // تحديث الجدول حياً
    db.collection("theses").orderBy("timestamp", "desc").onSnapshot(snapshot => {
        const tbody = document.getElementById('results-body');
        tbody.innerHTML = '';
        snapshot.docs.forEach((doc, i) => {
            const item = doc.data();
            const statusClass = item.status === 'متوفرة' ? 'bg-available' : 'bg-unavailable';
            tbody.insertAdjacentHTML('beforeend', `<tr><td>${i+1}</td><td style="font-weight:bold">${item.title}</td><td>${item.author}</td><td>${item.university}</td><td>${item.year}</td><td><span class="badge ${statusClass}">${item.status}</span></td></tr>`);
        });
    });
</script>
