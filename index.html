<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Libyan Theses Portal | LTP</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --red: #e74c3c; --green: #27ae60; --dark: #2d3436; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; margin: 0; padding: 5px; font-size: 14px; }
        header { background: white; border-bottom: 4px solid #000; padding: 8px; text-align: center; position: relative; }
        .h-red { color: var(--red); font-size: 16px; margin: 0; font-weight: bold; }
        .h-black { color: #000; font-size: 48px; font-weight: 900; margin: -5px 0; }
        .h-green { color: var(--green); font-size: 16px; margin: 0; font-weight: bold; }

        /* زر انضم إلينا */
        .join-btn { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); background: var(--green); color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; }

        .entry-section { background: #fff; padding: 10px; border-radius: 4px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        input, select { height: 28px; border: 1px solid #ccc; border-radius: 3px; padding: 0 8px; font-size: 13px; width: 100%; box-sizing: border-box; }
        
        .btn-row { display: flex; gap: 8px; justify-content: center; margin: 8px 0; }
        button { cursor: pointer; font-weight: bold; border: none; border-radius: 4px; }
        .btn-save { background: var(--green); color: white; height: 32px; padding: 0 25px; }
        .btn-excel { background: var(--dark); color: white; height: 32px; padding: 0 15px; }

        .filter-bar { background: #dfe6e9; padding: 8px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; border-right: 5px solid var(--green); }

        .table-wrap { height: 60vh; overflow-y: auto; background: white; border: 1px solid #ddd; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f8f9fa; position: sticky; top: 0; padding: 8px; border: 1px solid #ddd; }
        td { padding: 5px; border: 1px solid #eee; text-align: center; }

        /* النافذة المنبثقة */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); }
        .modal-content { background: white; margin: 5% auto; padding: 20px; width: 40%; border-radius: 8px; }
    </style>
</head>
<body>

<header>
    <button class="join-btn" onclick="document.getElementById('joinModal').style.display='block'">انضم إلينا</button>
    <p class="h-red">بوابة الرسائل الجامعية</p>
    <p class="h-black">LTP</p>
    <p class="h-green">Libyan Theses Portal</p>
</header>

<div class="entry-section">
    <input type="text" id="f-title" placeholder="عنوان الرسالة" class="nav" style="grid-column: span 2;">
    <input type="text" id="f-author" placeholder="اسم الباحث" class="nav">
    <input type="text" id="f-supervisor" placeholder="المشرف" class="nav">
    <select id="f-uni" class="nav"><option value="">الجامعة</option><option>طرابلس</option><option>بنغازي</option></select>
    <select id="f-college" class="nav"><option value="">الكلية</option><option>الآداب</option><option>الهندسة</option></select>
    <select id="f-dept" class="nav"><option value="">القسم</option><option>المكتبات</option><option>الحاسوب</option></select>
    <input type="number" id="f-year" value="2026" class="nav">
    <select id="f-loc" class="nav" style="grid-column: span 2;"><option value="">اختر المكتبة (مكان الرسالة)</option></select>
    <input type="text" id="f-id" placeholder="رقم الرسالة" class="nav">
</div>

<div class="btn-row">
    <button class="btn-save" id="btnSave">حفظ في السحابة</button>
    <button class="btn-excel" onclick="document.getElementById('xl').click()">استيراد Excel</button>
    <input type="file" id="xl" style="display:none" accept=".xlsx">
</div>

<div class="filter-bar">
    <input type="text" id="s-title" placeholder="بحث بالعنوان...">
    <select id="s-college"><option value="">كل الكليات</option><option>الآداب</option><option>الهندسة</option></select>
    <select id="s-dept"><option value="">كل الأقسام</option><option>المكتبات</option></select>
    <input type="number" id="s-year" placeholder="سنة">
    <select id="s-uni"><option value="">كل الجامعات</option><option>طرابلس</option></select>
</div>

<div class="table-wrap">
    <table>
        <thead>
            <tr>
                <th width="40%">العنوان والباحث</th>
                <th>الكلية / القسم</th>
                <th>المكان (المكتبة)</th>
                <th>الرقم</th>
                <th>السنة</th>
                <th>إجراءات</th>
            </tr>
        </thead>
        <tbody id="rows"></tbody>
    </table>
</div>

<div id="joinModal" class="modal">
    <div class="modal-content">
        <h3>طلب انضمام مكتبة للبوابة</h3>
        <div style="display:grid; gap:10px;">
            <input type="text" id="l-name" placeholder="اسم المكتبة">
            <input type="text" id="l-addr" placeholder="العنوان التفصيلي والموقع">
            <input type="email" id="l-email" placeholder="البريد الإلكتروني">
            <input type="text" id="l-phone" placeholder="هاتف التواصل">
            <button class="btn-save" onclick="submitJoin()">إرسال الطلب للمراجعة</button>
            <button style="background:#ccc; color:black; height:30px; border:none; border-radius:4px;" onclick="document.getElementById('joinModal').style.display='none'">إلغاء</button>
        </div>
    </div>
</div>

<script>
    // إعدادات Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBU-Y2l1rrpAPOpDhEXI7WjwACx0LgZLX0",
      authDomain: "ltp-libya.firebaseapp.com",
      projectId: "ltp-libya",
      appId: "1:761649252036:web:96e615cae0a5584f3bab91"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 1. تحميل أسماء المكتبات المعتمدة في القائمة المنسدلة تلقائياً
    db.collection("libraries").where("status", "==", "approved").onSnapshot(snap => {
        const sel = document.getElementById('f-loc');
        sel.innerHTML = '<option value="">اختر المكتبة (مكان الرسالة)</option>';
        snap.forEach(doc => {
            sel.innerHTML += `<option>${doc.data().name}</option>`;
        });
    });

    // 2. إرسال طلب انضمام
    async function submitJoin() {
        const data = { 
            name: document.getElementById('l-name').value, 
            addr: document.getElementById('l-addr').value,
            email: document.getElementById('l-email').value,
            status: "pending" 
        };
        await db.collection("libraries").add(data);
        alert("تم إرسال طلبك، سيتم مراجعته واعتماده قريباً.");
        document.getElementById('joinModal').style.display = 'none';
    }

    // 3. الحفظ والاستيراد والتصفية (كاملة ومصلحة)
    document.getElementById('btnSave').onclick = async function() {
        const data = {
            title: document.getElementById('f-title').value,
            author: document.getElementById('f-author').value,
            college: document.getElementById('f-college').value,
            dept: document.getElementById('f-dept').value,
            loc: document.getElementById('f-loc').value,
            year: document.getElementById('f-year').value,
            id_t: document.getElementById('f-id').value,
            uni: document.getElementById('f-uni').value,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection("theses").add(data);
        document.querySelectorAll('.nav').forEach(n => { if(n.id !== 'f-year') n.value = ''; });
    };

    // التصفية اللحظية (بالكلية لوحدها والباقي)
    function loadData() {
        db.collection("theses").orderBy("timestamp", "desc").onSnapshot(snap => {
            const body = document.getElementById('rows');
            const sTitle = document.getElementById('s-title').value.toLowerCase();
            const sColl = document.getElementById('s-college').value;
            const sDept = document.getElementById('s-dept').value;
            const sYear = document.getElementById('s-year').value;

            body.innerHTML = '';
            snap.forEach(doc => {
                const d = doc.data();
                if ((!sTitle || d.title.toLowerCase().includes(sTitle)) &&
                    (!sColl || d.college === sColl) &&
                    (!sDept || d.dept === sDept) &&
                    (!sYear || d.year == sYear)) {
                    body.insertAdjacentHTML('beforeend', `<tr>
                        <td style="text-align:right"><b>${d.title}</b><br><small>${d.author}</small></td>
                        <td>${d.college}<br><small>${d.dept}</small></td>
                        <td>${d.loc}</td>
                        <td style="color:blue; font-weight:bold">${d.id_t}</td>
                        <td>${d.year}</td>
                        <td><button onclick="delDoc('${doc.id}')" style="background:red; color:white; border:none; padding:2px 5px;">حذف</button></td>
                    </tr>`);
                }
            });
        });
    }

    ['s-title', 's-college', 's-dept', 's-year'].forEach(id => {
        document.getElementById(id).addEventListener('input', loadData);
    });

    window.onload = loadData;
</script>
</body>
</html>
